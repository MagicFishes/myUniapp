# 微信小程序获取头像和手机号说明

## 一、获取头像

### 1. 前端实现

在微信小程序中，需要使用 `<button>` 组件配合 `open-type="chooseAvatar"` 来获取头像：

```vue
<button 
  class="avatar-btn" 
  open-type="chooseAvatar" 
  @chooseavatar="onChooseAvatar"
>
  <image v-if="avatarUrl" :src="avatarUrl" class="avatar-image" />
</button>
```

### 2. 事件处理

```javascript
const onChooseAvatar = (e) => {
  const { avatarUrl } = e.detail
  // avatarUrl 是临时文件路径，需要上传到服务器
  uploadAvatar(avatarUrl)
}
```

### 3. 上传头像到服务器

使用 `uni.uploadFile` 上传头像：

```javascript
uni.uploadFile({
  url: 'https://your-api.com/upload/avatar',
  filePath: avatarUrl,
  name: 'avatar',
  header: {
    'Authorization': 'Bearer ' + token
  },
  success: (res) => {
    const data = JSON.parse(res.data)
    // 保存服务器返回的头像 URL
  }
})
```

### 4. 注意事项

- `avatarUrl` 是临时文件路径，需要及时上传到服务器
- 微信小程序中必须使用 `<button>` 组件，不能使用 `<view>` 或其他组件
- 需要配置服务器域名白名单（在微信公众平台配置）

---

## 二、获取手机号

### 1. wx.login 和 getPhoneNumber 的关系

**重要说明**：

- **getPhoneNumber 返回的 code 是独立的**，**不需要**先调用 `wx.login`
- **但在实际业务中**，通常需要先调用 `wx.login` 进行用户登录，建立用户会话
- **两个 code 的用途不同**：
  - `wx.login` 的 code：用于获取 `openid` 和 `session_key`，建立用户身份
  - `getPhoneNumber` 的 code：专门用于获取手机号，不能用于登录

**推荐流程**：
1. 用户进入小程序时，先调用 `wx.login` 进行登录，获取用户身份（openid）
2. 用户点击"获取手机号"按钮时，使用 `getPhoneNumber` 返回的 code 获取手机号
3. 将手机号与已登录的用户账号（openid）关联

### 2. 前端实现

#### 2.1 用户登录（wx.login）

```javascript
// 在小程序启动时或需要登录时调用
const login = async () => {
  return new Promise((resolve, reject) => {
    uni.login({
      provider: 'weixin',
      success: async (res) => {
        const loginCode = res.code // 这是登录用的 code
        
        // 发送到后端，获取 openid 和 session_key
        const loginRes = await uni.request({
          url: 'https://your-api.com/user/login',
          method: 'POST',
          data: { code: loginCode }
        })
        
        // 保存 token 或用户信息
        // uni.setStorageSync('token', loginRes.data.token)
        resolve(loginRes.data)
      },
      fail: (err) => {
        reject(err)
      }
    })
  })
}
```

#### 2.2 获取手机号

在微信小程序中，需要使用 `<button>` 组件配合 `open-type="getPhoneNumber"` 来获取手机号：

```vue
<button 
  class="phone-btn" 
  open-type="getPhoneNumber" 
  @getphonenumber="onGetPhoneNumber"
>
  获取手机号
</button>
```

#### 2.3 事件处理

```javascript
const onGetPhoneNumber = async (e) => {
  // 用户拒绝授权
  if (e.detail.errMsg === 'getPhoneNumber:fail user deny') {
    return
  }
  
  const { code } = e.detail // 这是获取手机号专用的 code，与 wx.login 的 code 不同
  
  // 调用后端接口获取手机号
  const res = await uni.request({
    url: 'https://your-api.com/user/getPhoneNumber',
    method: 'POST',
    header: {
      'Authorization': 'Bearer ' + token // 使用登录时获取的 token
    },
    data: { code } // 使用 getPhoneNumber 返回的 code
  })
}
```

### 3. 后端接口实现（Node.js 示例）

#### 3.1 用户登录接口（wx.login 的 code）

```javascript
const axios = require('axios')

// 用户登录接口
app.post('/user/login', async (req, res) => {
  const { code } = req.body // wx.login 返回的 code
  
  try {
    // 通过 code 获取 session_key 和 openid
    const tokenRes = await axios.get('https://api.weixin.qq.com/sns/jscode2session', {
      params: {
        appid: 'your-appid',
        secret: 'your-secret',
        js_code: code,
        grant_type: 'authorization_code'
      }
    })
    
    const { session_key, openid } = tokenRes.data
    
    // 根据 openid 查找或创建用户
    // 生成 token 返回给前端
    const token = generateToken(openid)
    
    res.json({
      code: 200,
      data: {
        token: token,
        openid: openid
      }
    })
  } catch (error) {
    res.json({
      code: 500,
      message: '登录失败'
    })
  }
})
```

#### 3.2 获取手机号接口（getPhoneNumber 的 code）

```javascript
// 获取手机号接口
app.post('/user/getPhoneNumber', async (req, res) => {
  const { code } = req.body // getPhoneNumber 返回的 code（与登录的 code 不同）
  const token = req.headers.authorization?.replace('Bearer ', '')
  
  try {
    // 1. 验证用户是否已登录（通过 token 获取 openid）
    const userInfo = verifyToken(token)
    if (!userInfo) {
      return res.json({
        code: 401,
        message: '请先登录'
      })
    }
    
    // 2. 获取 access_token
    const tokenRes = await axios.get('https://api.weixin.qq.com/cgi-bin/token', {
      params: {
        grant_type: 'client_credential',
        appid: 'your-appid',
        secret: 'your-secret'
      }
    })
    
    const access_token = tokenRes.data.access_token
    
    // 3. 使用 getPhoneNumber 的 code 获取手机号
    const phoneRes = await axios.post(
      `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${access_token}`,
      {
        code: code // 使用 getPhoneNumber 返回的 code
      }
    )
    
    const phoneInfo = phoneRes.data.phone_info
    
    // 4. 将手机号与用户账号（openid）关联
    await updateUserPhone(userInfo.openid, phoneInfo.phoneNumber)
    
    res.json({
      code: 200,
      data: {
        phoneNumber: phoneInfo.phoneNumber,
        purePhoneNumber: phoneInfo.purePhoneNumber,
        countryCode: phoneInfo.countryCode
      }
    })
  } catch (error) {
    res.json({
      code: 500,
      message: '获取手机号失败'
    })
  }
})
```

### 4. 新版获取手机号方式（推荐）

微信小程序提供了新的获取手机号方式，使用 `code` 直接获取：

```javascript
// 后端接口
const axios = require('axios')

app.post('/user/getPhoneNumber', async (req, res) => {
  const { code } = req.body
  
  try {
    // 1. 获取 access_token
    const tokenRes = await axios.get('https://api.weixin.qq.com/cgi-bin/token', {
      params: {
        grant_type: 'client_credential',
        appid: 'your-appid',
        secret: 'your-secret'
      }
    })
    
    const access_token = tokenRes.data.access_token
    
    // 2. 使用 code 获取手机号
    const phoneRes = await axios.post(
      `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${access_token}`,
      {
        code: code
      }
    )
    
    const phoneInfo = phoneRes.data.phone_info
    
    res.json({
      code: 200,
      data: {
        phoneNumber: phoneInfo.phoneNumber,
        purePhoneNumber: phoneInfo.purePhoneNumber,
        countryCode: phoneInfo.countryCode
      }
    })
  } catch (error) {
    res.json({
      code: 500,
      message: '获取手机号失败'
    })
  }
})
```

### 5. 注意事项

- **手机号解密必须在后端进行**，前端无法直接解密
- 需要先调用 `code2Session` 获取 `session_key`（旧版方式）
- 新版方式直接使用 `code` 调用微信接口获取手机号
- `code` 只能使用一次，且有效期为 5 分钟
- 需要配置服务器域名白名单
- 需要在小程序管理后台配置手机号权限

---

## 三、配置要求

### 1. 微信公众平台配置

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「开发」->「开发管理」->「开发设置」
3. 配置「服务器域名」：
   - request 合法域名：添加你的 API 域名
   - uploadFile 合法域名：添加你的上传接口域名
   - downloadFile 合法域名：添加你的下载接口域名

### 2. 小程序权限配置

在 `manifest.json` 中配置权限：

```json
{
  "mp-weixin": {
    "permission": {
      "scope.userInfo": {
        "desc": "用于完善用户资料"
      }
    }
  }
}
```

### 3. 页面配置

在 `pages.json` 中添加页面路由：

```json
{
  "pages": [
    {
      "path": "pages/user-info/index",
      "style": {
        "navigationBarTitleText": "个人信息"
      }
    }
  ]
}
```

---

## 四、常见问题

### 1. 获取头像失败

- 检查是否使用了 `<button>` 组件
- 检查是否设置了 `open-type="chooseAvatar"`
- 检查是否绑定了 `@chooseavatar` 事件

### 2. 获取手机号失败

- 检查是否使用了 `<button>` 组件
- 检查是否设置了 `open-type="getPhoneNumber"`
- 检查是否绑定了 `@getphonenumber` 事件
- 检查后端接口是否正确实现
- 检查服务器域名是否已配置

### 3. 上传头像失败

- 检查服务器域名白名单配置
- 检查上传接口是否正确
- 检查请求头是否包含必要的认证信息

---

## 五、wx.login 和 getPhoneNumber 的关系总结

### 核心要点

1. **两个 code 是独立的**
   - `wx.login` 返回的 code：用于用户登录，获取 `openid` 和 `session_key`
   - `getPhoneNumber` 返回的 code：专门用于获取手机号
   - **两者不能混用**，也不能互相替代

2. **是否需要先调用 wx.login？**
   - **技术上**：不需要。`getPhoneNumber` 的 code 可以直接获取手机号
   - **业务上**：通常需要。因为需要：
     - 建立用户身份（通过 openid）
     - 将手机号与用户账号关联
     - 管理用户会话（token）

3. **推荐流程**
   ```
   用户进入小程序
   ↓
   调用 wx.login 进行登录（获取 openid，建立用户身份）
   ↓
   用户点击"获取手机号"按钮
   ↓
   使用 getPhoneNumber 返回的 code 获取手机号
   ↓
   后端将手机号与 openid 关联
   ```

4. **代码示例对比**

```javascript
// 1. wx.login - 用于登录
uni.login({
  provider: 'weixin',
  success: (res) => {
    const loginCode = res.code // 登录用的 code
    // 发送到后端：/user/login
    // 后端返回：token, openid
  }
})

// 2. getPhoneNumber - 用于获取手机号
<button open-type="getPhoneNumber" @getphonenumber="onGetPhoneNumber">
const onGetPhoneNumber = (e) => {
  const phoneCode = e.detail.code // 获取手机号用的 code（与登录的 code 不同）
  // 发送到后端：/user/getPhoneNumber
  // 后端返回：phoneNumber
}
```

### 常见错误

❌ **错误**：使用 `getPhoneNumber` 的 code 去调用 `code2Session` 接口
```javascript
// 错误示例
const phoneCode = e.detail.code // getPhoneNumber 的 code
// 不能用于登录！
uni.request({
  url: '/user/login',
  data: { code: phoneCode } // ❌ 错误！
})
```

✅ **正确**：分别使用各自的 code
```javascript
// 正确示例
// 1. 登录时使用 wx.login 的 code
uni.login({
  success: (res) => {
    uni.request({
      url: '/user/login',
      data: { code: res.code } // ✅ wx.login 的 code
    })
  }
})

// 2. 获取手机号时使用 getPhoneNumber 的 code
const onGetPhoneNumber = (e) => {
  uni.request({
    url: '/user/getPhoneNumber',
    data: { code: e.detail.code } // ✅ getPhoneNumber 的 code
  })
}
```

## 六、完整示例

参考 `pages/user-info/index.vue` 文件，包含完整的实现代码，包括：
- 用户登录（wx.login）
- 获取头像（chooseAvatar）
- 获取手机号（getPhoneNumber）

